<!doctype html>
<html>
    <head> <!--DUPLICATE CODE START-->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Virtual Cards against Cards</title>

        <link rel="stylesheet" href="stylesheets/w3.css">
        <link rel="stylesheet" href="stylesheets/cards.css">
        <link rel="stylesheet" href="stylesheets/card-effects.css">
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
        
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta property="og:title" content="Virtual Cards against Cards" />
    </head>
    <body>
        <style>
            .wait-for-load {}
            /*.answers {}*/
        </style>	
        <script src="javascripts/jQuery.js"></script>
        <script type="text/javascript">

            var cardUi = {}; 

            var dragDrop = {}; 
            
            var cardApi = {};
            
            var cardSelection = [];
            
            var gameObj = {};

        </script>
        <script src="javascripts/cardUi.js"></script> <!-- cardUi global is set up as functional object here -->
        <script src="javascripts/dragDrop.js"></script> <!-- dragDrop global is set up as functional object here -->
        <script src="javascripts/cardApi.js"></script> <!-- dragDrop global is set up as functional object here -->

        <script type="text/javascript">
            window.onload = function(event) {
                //$('.answers').hide();
                $('#divAnswersArea').hide();
                $('#btnSubmitAnswer').hide();

                var player = cardApi.getParameterByName('Player');
                console.log(' @@@@@ ' +player);
                $('#txtPlayerName').text(player);

                var game = cardApi.getParameterByName('Game');
                console.log(' @@@@@ g' + game);
                $('#txtGameName').text(game);
                              
                getRefreshed(cardSelection);
            }
        </script>
        <script type="text/javascript">
            function dragStart(ev) {
                console.log('drag effect func dragStart called');
                console.log(ev.target);
            }
        </script> <!--DUPLICATE CODE END-->
        <div id='wrapper' class='w3-padding-tiny'>
            <div class='w3-card-8 card-area card-twisle'>
                <header>
                    <h1 class='w3-center'>Virtual Cards against Cards</h1>
                </header>
            </div>
            <div class='w3-row'>
                <div class='w3-card-16 card-area w3-col w3-container m3 w3-animate-opacity'>
                    <p class='w3-padding-small w3-tiny'>
                        <b><span id='txtPlayerName'>douchebag</span></b>,   <i><span id='txtGameName'></span></i>  (<span id='txtRoundNumber' class='w3-tiny'></span>)
                    </p> 
                    <div class='card card-horizontal card-spin-delay1 w3-padding-small w3-tiny' 
                        onclick='cardSelect(event)'
                        ondrop="dragDrop.drop(event, dragStart)" 
                        ondragover="dragDrop.allowDrop(event, dragStart)" 
                        draggable="true" 
                        ondragstart="dragDrop.drag(event, dragStart)"
                        id='card1' >1</div>
                    <div class='card card-horizontal card-jump w3-padding-small w3-tiny' 
                        onclick='cardSelect(event)' 
                        ondrop="dragDrop.drop(event, dragStart)" 
                        ondragover="dragDrop.allowDrop(event, dragStart)" 
                        draggable="true" 
                        ondragstart="dragDrop.drag(event, dragStart)"
                        id='card2' >2</div>
                    <div class='card card-horizontal w3-padding-small w3-tiny' 
                        onclick='cardSelect(event)' 
                        ondrop="dragDrop.drop(event, dragStart)" 
                        ondragover="dragDrop.allowDrop(event, dragStart)" 
                        draggable="true" 
                        ondragstart="dragDrop.drag(event, dragStart)"
                        id='card3' >3</div>
                    <div class='card card-horizontal card-jump-delay2 w3-padding-small w3-tiny' 
                        onclick='cardSelect(event)' 
                        ondrop="dragDrop.drop(event, dragStart)" 
                        ondragover="dragDrop.allowDrop(event, dragStart)" 
                        draggable="true" 
                        ondragstart="dragDrop.drag(event, dragStart)"
                        id='card4' >4</div>
                    <div class='card card-horizontal card-spin-delay2 w3-padding-small w3-tiny' 
                        onclick='cardSelect(event)' 
                        ondrop="dragDrop.drop(event, dragStart)" 
                        ondragover="dragDrop.allowDrop(event, dragStart)" 
                        draggable="true" 
                        ondragstart="dragDrop.drag(event, dragStart)"
                        id='card5' >5</div>
                    <div class='w3-center'>
                        <button id='btnResetSelection' class='w3-btn w3-khaki' onclick='onClickResetSelection(event)'>Reset <span class='fa fa-eraser'> </span></button>
                    </div>
                </div>
                <div class='w3-card-16 card-area w3-container w3-col m5 w3-animate-opacity'>
                    <div id='divQuestionArea'>
                        <p>Question</p>
                        <div id ='txtQuestion' class ='w3-padding-small w3-large'></div>
                        <button id ='btnSubmitAnswer' class='w3-btn w3-purple w3-animate-opacity w3-right' onclick='onSubmitAnswer(event)'>Submit <span class='fa fa-gavel'> </span></button>
                    </div>
                    <div id='divAnswersArea'>                    
                        <div id='txtAnswers' class ='w3-padding-small w3-large'><div>asdfasdfasdfasdf</div></div>
                        <button id ='btnSubmitVote' class='w3-btn w3-deep-purple w3-animate-opacity w3-right' onclick='onSubmitVote(event)'>Vote <span class='fa fa-gavel'> </span></button>
                    </div>
                       
                </div>
            </div>
            <div class='w3-center'>
                <button 
                    class='w3-btn w3-blue' 
                        onclick='onClickRefresh(event)'>Refresh <span class='fa fa-refresh'> </span> <span class='wait-for-load fa fa-bell w3-small w3-spin'> </span></button>
            </div>
        </div>
        
    <script>
/*
    submit
        ~remove used cards
        ~replace used cards
        ~get other submitted answers        

        ~hide question submision
        ~show answers panel
        ~fade out previous winner and answer
    refresh
    
    select vote
    
    refresh
    
    post vote
    
    refresh
    
    if all voted show winner
    (delay showing the 'next' button)
    CreateRound/JoinRound
    
        

            
*/
            function cardSelect(ev) {
                var negociateSelection = function (target, isSelected, cardSelection) {                    
                    //console.log(txt);
                    if (!isSelected) {
                        var txt = target.text();
                        var removeIndex = -1;
                        for (var card in cardSelection) {
                            if (cardSelection[card] == txt) {
                                removeIndex = card;
                                break;
                            }
                        }
                        cardSelection.splice(removeIndex, 1);
                    } else {
                        var questionBlankCount = 1;
                        try { questionBlankCount = gameObj.questionBlankCount; } 
                        catch (err) { return false;/*questionBlankCount = 1;*/ }
                        
                        if (cardSelection.length >= questionBlankCount) {
                            return false;
                        } else {
                            cardSelection.push(target.text());                            
                        }
                    }
                    
                    window.setTimeout( function (gameObj) {
                        refreshQuestionText(gameObj, cardSelection);                        
                    }, 0, gameObj);
                    
                    //console.log(JSON.stringify(cardSelection));
                    return true;
                }
                
                cardUi.onCardSelect(ev, cardSelection, negociateSelection)

              /*   if (cardSelection.length == 0) {
                    $('#btnResetSelection').hide();
                } else {
                    $('#btnResetSelection').show();
                } */
                
            }
            
            function onClickResetSelection(event) {
                var target = $('.card-selected');
                cardUi.setCardSelectionEffects(target, false);
                target.toggleClass('card-selected', false);
                cardSelection = [];
                
                refreshQuestionText(gameObj, cardSelection);
            }
            
            function onClickRefresh(event) {
                getRefreshed(cardSelection);
            }
            
            function getRoot(referrer) {
                var len = referrer.lastIndexOf('/');
                if (len == -1) len = referrer.length;
                var url = referrer.substr(0, len);
                return url;
            }
            
            function onSubmitAnswer(event) {
                var xmlhttp = new XMLHttpRequest();
                
                var passName = $('#txtGameName').text();
                var playerName = $('#txtPlayerName').text();
                
                var answer = $('#txtQuestion').html();
                var url = getRoot(window.document.referrer);
                var submitAnswerLocation = url + '/SubmitAnswer?Game=' + passName + '&Player=' + playerName + '&Answer=' + answer;
                
                xmlhttp.open("GET", submitAnswerLocation);
                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == 4) {
                        if (xmlhttp.status == 400 || xmlhttp.status == 200) {
                            $('#divQuestionArea').hide();
                            $('#divAnswersArea').show();                            
                            getRefreshed(cardSelection);
                        }
                    }
                    
                };
                xmlhttp.send();
                
            }
            
            function refreshQuestionText(gameObj, cardSelection) {
                var filledInQuestion = gameObj.question.replace(/________/g, '______');
                
                for (var answer in cardSelection) {
                    filledInQuestion = filledInQuestion.replace(/______/, '<span class="w3-small">' + cardSelection[answer] + '</span>');
                }
                $('#txtQuestion').html(filledInQuestion, cardSelection);
                
                if (cardSelection.length > 0 && cardSelection.length == gameObj.questionBlankCount) {
                    $('#btnSubmitAnswer').show();
                } else {
                    $('#btnSubmitAnswer').hide();
                }
            }
            
            function getRefreshed(cardSelection) {
                var xmlhttp = new XMLHttpRequest();

                var passName = $('#txtGameName').text();
                var playerName = $('#txtPlayerName').text();

/*                 var getRoot = function getRoot(referrer) {
                    var len = referrer.lastIndexOf('/');
                    if (len == -1) len = referrer.length;
                    var url = referrer.substr(0, len);
                    return url;
                }; */
                var url = getRoot(window.document.referrer);
                
                var updateRoundLocation = url + '/UpdateRound?Game=' + passName + '&Player=' + playerName;
                var updateRoundSuccessFunc = function (xmlhttp, passName, playerName, joinOnly) {

                    console.log(joinOnly + ': ' + xmlhttp.responseText);

                    gameObj = JSON.parse(xmlhttp.responseText);
                    console.log(gameObj);

                    if (gameObj.game == passName) {
                        window.setTimeout( function () {
                            $('#txtRoundNumber').text('Round ' + gameObj.roundCount);
                            refreshQuestionText(gameObj, cardSelection);                        
                            
                            var cardIdSelectorTemplate = '#card';
                            var index = 0;
                            for (var myCard in gameObj.heldCards) {
                                index++;
                                $(cardIdSelectorTemplate + index.toString()).text(gameObj.heldCards[myCard]);
                                console.log(gameObj.heldCards[myCard]);
                            }                        
                            
                            if (gameObj.players.voted.length > 0) {
                                // voted
                                var votedStr = '<h6>Voted</h6>';
                                for (var voted in gameObj.voted) {
                                    var name = gameObj.game.list[voted];
                                    votedStr += '<p class="card-spin"><span class="fa fa-thumbs-up" /><i> '+name+'</i></p>';
                                }
                            } 
                            
                            if (gameObj.players.submitted.length > 0) {
                                // submitted
                                var submittedStr = '<h6>Submitted</h6>';
                                for (var submitted in gameObj.submitted) {
                                    var name = gameObj.game.list[submitted];
                                    submittedStr += '<p class="card-spin"><span class="fa fa-thumbs-up" /><i> '+name+'</i></p>';
                                    //$('.answers').show();
                                }
                                $('#txtAnswers').html(submittedStr);
                                $('#divQuestionArea').show();
                            }
                        }, 0);
                    }
                }

                cardApi.joinOrCreateOrStartGame(xmlhttp, updateRoundLocation, passName, playerName, updateRoundSuccessFunc, false);

            }

//            // refire the animation
//            $(".card").click(function () {
//                var stripEffects = function () {
//                    return $('div.card')
//                        .removeClass('card-twisle card-spin card-jiggle card-flash card-twisle card-jump card-shake');
//                }

//                console.log('click ::::');
//                stripEffects()
//                    .ready(cardUi.fireEffect($(this)));
//            });
        </script>

    </body>
</html>