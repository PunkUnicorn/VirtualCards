<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <title>Virtual Cards against Cards</title>

        <link rel="stylesheet" href="stylesheets/w3.css">
        <link rel="stylesheet" href="stylesheets/cards.css">
        <link rel="stylesheet" href="stylesheets/card-effects.css">
<!-- http://fortawesome.github.io/Font-Awesome/icons/ -->
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta property="og:title" content="Virtual Cards against Cards" />
    </head>
    <body>
        <script src="javascripts/jQuery.js"></script>
        <script type="text/javascript">

            var cardUi = {}; 

            var dragDrop = {}; 
            
            var cardApi = {};

        </script>
        <script src="javascripts/cardUi.js"></script> <!-- cardUi global is set up as functional object here -->
        <script src="javascripts/dragDrop.js"></script> <!-- dragDrop global is set up as functional object here -->
        <script src="javascripts/cardApi.js"></script> <!-- dragDrop global is set up as functional object here -->

        <script type="text/javascript">
            function dragStart(ev) {
                console.log('drag effect func dragStart called');
                console.log(ev.target);
            }
        </script> <!--DUPLICATE CODE END-->
        <style>
            .join-enabled {}
            .wait-for-load {}
            .wait-for-game {}
            .wait-for-game-info1 {}
            .wait-for-game-info2 {}
            .wait-for-game-info3 {}
            .wait-for-game-info4 {}
            .wait-for-game-info5 {}
            .start-game {}
        </style>
        <div id='wrapper' class='w3-animate-opacity'>
            <div><!--  class='w3-animate-top'> -->
                <div> <!-- class='w3-animate-bottom'> -->
                    <div class='w3-card-8 card-area card-twisle'>
                        <header>
                            <h1 class='w3-center'>Virtual Cards Against Cards</h1>
                            <h6 class='w3-center'>Virtual Cards Against Humanity 0.5 <span class='w3-large'><b>T</b></span></h6>
                        </header>
                    </div>
                </div>
                <div class='w3-row w3-center'>
                    <div class='w3-col w3-card-16 card-area w3-animate-top'>
                        <p>Welcome <span id='txtPlayerName'>douchebag</span></p>
                        <p>It's not my place to judge you</p>
                        <p id='txtNoGame'>Enter the name of an existing game. Or enter the name of a new game to create it</p>
                        <p id='txtGamePassed'>Press Join/Create Game to begin</p>
                        <label for='txtGameName' class='w3-large'>Name</label>
                        <input id='txtGameName' oninput="cleanUi()" class='w3-input w3-blue-grey'/> 
                        <div class='w3-center w3-padding-small'>
                            <div class='card-horizontal wait-for-game-info1 w3-padding-tiny w3-tiny'></div>
                            <div class='card-horizontal wait-for-game-info2 w3-padding-tiny w3-tiny'></div>
                            <input class='w3-tiny w3-half w3-input w3-blue-grey' onclick='this.setSelectionRange(0, this.value.length)' id='txtGameLink' readonly></input>
                            <div class='card-horizontal wait-for-game-info4 w3-padding-tiny w3-tiny'></div>
                            <div class='card card-horizontal wait-for-game-info5 w3-padding-tiny w3-tiny'>
                                <div class='card-horizontal wait-for-game-info3 w3-padding-tiny w3-tiny'></div>
                                <p><button 
                                    onclick='onClickJoinCreate()'
                                    class='join-enabled w3-btn w3-blue w3-animate-opacity'>Create/Join game <span 
                                        class='wait-for-load fa fa-bell w3-small w3-spin' />
                                </button></p>
                            </div>
                            <p><button 
                                onclick='onClickStart()'
                                class='start-game w3-padding-small w3-tiny w3-btn w3-grey w3-right'>Start game <span class='wait-for-game fa fa-cube w3-spin' />
                            </button></p>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function cleanUi() {
                $('.wait-for-game-info1').html('');
                $('.wait-for-game-info2').html('');
                $('.wait-for-game-info3').html('');
                $('.wait-for-game-info4').html('');
                 
                $('.join-enabled').text("Join/Create Game");
                
                var txtLen = $('#txtGameName').val().length;
                if (txtLen > 2) $('.join-enabled').show()
                else $('.join-enabled').hide();
                
                $('.wait-for-load').hide();
                $('.start-game').hide();
                $('#txtGameLink').hide();
                $('.wait-for-game').hide();
            };
            
            window.onload = function (event) {                

                var player = cardApi.getParameterByName('Player');
                $('#txtPlayerName').text(player);

                var game = cardApi.getParameterByName('Game');
                $('#txtGameName').val(game);

                if (game.length == 0) {
                    $('#txtGameName').focus();
                    $('#txtGamePassed').hide();
                } else {
                    $('.start-game').focus();
                    $('#txtNoGame').hide();
                }
                
                cleanUi();
            };

            function playRound(passName, playerName) {
                var playRoundLocation = cardApi.getRoot(window.document.URL) + '/PlayRoundUi?Game=' + encodeURIComponent( passName )+ '&Player=' + encodeURIComponent( playerName );
                window.document.location = playRoundLocation;
            };
            
            function onClickStart(event) {
                var xmlhttp = new XMLHttpRequest();

                var passName =  $('#txtGameName').val();
                var playerName =  $('#txtPlayerName').text();

                var startGameLocation = cardApi.getRoot(window.document.URL) + '/CreateRound?Game=' + encodeURIComponent( passName ) + '&Player=' + encodeURIComponent( playerName );
                var startSuccessFunc = function (responseText, NA, passName, playerName, joinOnly) {
                    playRound(passName, playerName);
                }

                const NOTAPPLICABLE = -1;
                cardApi.joinOrCreateThing(xmlhttp, startGameLocation, NOTAPPLICABLE, passName, playerName, startSuccessFunc, false);
            }
            
            function onClickJoinCreate(event) {			
                var xmlhttp = new XMLHttpRequest();

                var passName = $('#txtGameName').val();
                var playerName =  $('#txtPlayerName').text();

                var root = cardApi.getRoot(window.document.URL);
                var joinGameLocation = root + '/JoinGame?Game=' + encodeURIComponent( passName ) + '&Player=' + encodeURIComponent( playerName );
                var joinSuccessFunc = function (responseText, xmlhttp, passName, playerName, joinOnly) {

                    var responseObj = JSON.parse(responseText);

                    if (responseObj.game == passName) {
                        var setUi = function (responseObj, playerCount, passName, playerName) {
                            $('.wait-for-game').show();
                            $('.join-enabled').text('Refresh');

                            $('.wait-for-game-info1').html('<b>' + responseObj.game + '</b>');
                            $('.wait-for-game-info3').html('<i>' + playerCount 
                                    + ' player(s)</i><p>waiting for '
                                    + responseObj.creator 
                                    + ' <span class="fa fa-spinner fa-pulse" /></p>');
                                    
                            var playerListObj = responseObj.list;
                            var playerListStr = '';
                            for (i=0;i<playerListObj.length;i++){
                                playerListStr += '<p class="card-spin"><span class="fa fa-thumbs-up" /><i> '+playerListObj[i]+'</i></p>';
                            }

                            $('.wait-for-game-info4').html(playerListStr);

                            if (responseObj.creator == playerName) {
                                $('.wait-for-game-info2').html('<b class="w3-red w3-animate-opacity w3-middle">YOU CREATED THIS GAME. PRESS START TO START.<br /><i> Or pass the link to invite people </i></b>'); 
                                $('.start-game').show();
                                var link = cardApi.getRoot(window.document.URL) + '/?Game=' + encodeURIComponent( passName );
                                $('#txtGameLink').val(link).show();
                            }
                        };
                        
                        var playerCount = responseObj.list.length;
                        setUi(responseObj, playerCount, passName, playerName);
                        
                        if (responseObj.roundCount == 1) {
                            playRound(passName, playerName);
                        }
                    } else {
                        var createGameLocation = window.location.protocol + '//' + window.location.host + '/CreateGame?Game=' + encodeURIComponent( passName ) + '&Player=' + encodeURIComponent( playerName );
                        var createSuccessFunc = function (responseText, xmlhttp, passName, playerName, joinOnly) {
                            cardApi.joinOrCreateThing(xmlhttp, joinGameLocation, xmlhttp, passName, playerName, joinSuccessFunc, true);
                        }

                        if (!joinOnly) {
                            cardApi.joinOrCreateThing(xmlhttp, createGameLocation, xmlhttp, passName, playerName, createSuccessFunc, false);
                        }
                    }
                }
                const NOTAPPLICABLE = -1;
                cardApi.joinOrCreateThing(xmlhttp, joinGameLocation, xmlhttp, passName, playerName, joinSuccessFunc, false);
            }
        </script>
    </body>
</html>
